<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="UTF-8">
    <title>Insert title here</title>


<!--<meta id="_csrf" name="_csrf" content="${_csrf.token}" />-->
<!--<meta id="_csrf_header" name="_csrf_header" content="${_csrf.headerName}" />-->

</head>
<body>

	<div th:replace="/include/header.html"></div>


<script>
    $(document).ready(function () {
        calculateToalPrice();
        $("#count").change(function () {
            calculateToalPrice();
        });
    });

    function calculateToalPrice() {
        var count = $("#count").val();
        var price = $("#price").val();
        var totalPrice = price * count;
        $("#totalPrice").html(totalPrice + '원');
    }

    function order() {

        var url = "/order";
        var paramData = {
            itemId: $("#itemId").val(),
            count: $("#count").val()
        };

        var param = JSON.stringify(paramData);

        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: param,

            dataType: "json",
            cache: false,
            success: function (result, status) {
                alert("주문이 완료 되었습니다.");
                location.href = '/';
            },
            error: function (jqXHR, status, error) {

                if (jqXHR.status == '401') {
                    alert('로그인 후 이용해주세요');
                    location.href = '/login';
                } else {
                    alert(jqXHR.responseText);
                }

            }
        });
    }


    function addCart() {
        /* var token = $("meta[name='_csrf']").attr("content");
         var header = $("meta[name='_csrf_header']").attr("content"); */

		<div class="d-flex detail-mt-md">
			<div class="repImgDiv">
				<!-- <img th:src="${item.itemImgDtoList[0].imgUrl}"
					class="rounded repImg" th:alt="${item.itemNm}"> -->
			</div>
			<div class="wd50">
				<span
					th:if="${item.itemSellStatus == T(com.jjjteam.jmarket.constant.ItemSellStatus).SELL}"
					class="badge badge-primary mgb-15"> 판매중 </span> <span
					th:unless="${item.itemSellStatus == T(com.jjjteam.jmarket.constant.ItemSellStatus).SELL}"
					class="badge btn-danger mgb-15"> 품절 </span>
				<div class="h4" th:text="${item.itemNm}"></div>
				<div class="h6" th:text="${item.itemIntroduction}"></div>
				<hr class="my-4">

        let paramData = {
            itemId: $("#itemId").val(),
            count: $("#count").val()
        };
        $.ajax({
            url: "/cart",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(paramData),
            dataType: "json",
            cache: false,
            success: function (result) {
                alert("상품을 장바구니에 담았습니다.");
                location.href = "/cart";
            },

            error: function (jqXHR, status, error) {

                if (jqXHR.status == '401') {
                    alert('로그인 후 이용해주세요');
                    location.href = '/login';
                } else {
                    console.log(jqXHR.responseText);
                }
            }
        });
    }

</script>


<div class="container container-mt">

    <input id="itemId" th:value="${item.id}" type="hidden">

    <div class="d-flex detail-mt-md">
        <div class="repImgDiv">
            <!-- <img th:src="${item.itemImgDtoList[0].imgUrl}"
                class="rounded repImg" th:alt="${item.itemNm}"> -->
        </div>
        <div class="wd50">
            <img alt="첨부이미지" id="imgId" th:if="${item.repimg != null}" th:src="${item.repimg}"/>
            <span class="badge badge-primary mgb-15"
                  th:if="${#strings.equals(item.itemSellStatus,T(com.jjjteam.jmarket.constant.ItemSellStatus).SELL)}"> 판매중 </span>
            <span class="badge btn-danger mgb-15"
                  th:unless="${#strings.equals(item.itemSellStatus,T(com.jjjteam.jmarket.constant.ItemSellStatus).SELL)}"> 품절 </span>
            <div class="h4" th:text="${item.itemNm}"></div>
            <div class="h6" th:text="${item.itemIntroduction}"></div>
            <hr class="my-4">

            <div class="text-right">
                <div class="h4 text-danger text-left">
                    <input id="price" name="price" th:value="${item.price}"
                           type="hidden"> <span th:text="${item.price}"></span>원
                </div>
                <div class="input-group w-50">
                    <div class="input-group-prepend">
                        <span class="input-group-text">수량</span>
                    </div>
                    <input class="form-control" id="count" min="1" name="count"
                           type="number" value="1">
                </div>
            </div>
            <hr class="my-4">

            <div class="text-right mgt-50">
                <h5>결제 금액</h5>
                <h3 class="font-weight-bold" id="totalPrice" name="totalPrice"></h3>
            </div>
            <div
                    class="text-right"
                    th:if="${#strings.equals(item.itemSellStatus,T(com.jjjteam.jmarket.constant.ItemSellStatus).SELL)}">
                <button class="btn btn-light border border-primary btn-lg"
                        onclick="addCart()"
                        type="button">장바구니 담기
                </button>
                <button class="btn btn-primary btn-lg" onclick="order()"
                        type="button">주문하기
                </button>
            </div>
            <div
                    class="text-right"
                    th:unless="${#strings.equals(item.itemSellStatus,T(com.jjjteam.jmarket.constant.ItemSellStatus).SELL)}">
                <button class="btn btn-danger btn-lg" type="button">품절</button>
            </div>
            <div>본문내용</div>
            <div th:utext="${item.itemDetail}"></div>
        </div>
    </div>


</div>


<div th:replace="/include/footer.html"></div>
</body>
</html>